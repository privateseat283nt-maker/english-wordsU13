// ===== Vocabulary Data (Tokyo Shoseki New Horizon 1 - 448 words) =====
const vocabulary = [
    { japanese: "1つの", english: "a" },
    { japanese: "できる，有能な", english: "able" },
    { japanese: "午後", english: "afternoon" },
    { japanese: "再び", english: "again" },
    { japanese: "年齢，時代", english: "age" },
    { japanese: "前", english: "ago" },
    { japanese: "すべての", english: "all" },
    { japanese: "すでに", english: "already" },
    { japanese: "もまた", english: "also" },
    { japanese: "いつも", english: "always" },
    { japanese: "アメリカ合衆国", english: "America" },
    { japanese: "1つの", english: "an" },
    { japanese: "～と、そして", english: "and" },
    { japanese: "怒った", english: "angry" },
    { japanese: "動物", english: "animal" },
    { japanese: "りんご", english: "apple" },
    { japanese: "４月", english: "April" },
    { japanese: "到着する", english: "arrive" },
    { japanese: "～に", english: "at" },
    { japanese: "８月", english: "August" },
    { japanese: "おば", english: "aunt" },
    { japanese: "オーストラリア", english: "Australia" },
    { japanese: "秋", english: "autumn" },
    { japanese: "悪い", english: "bad" },
    { japanese: "カバン", english: "bag" },
    { japanese: "ボール", english: "ball" },
    { japanese: "銀行，土手", english: "bank" },
    { japanese: "野球", english: "baseball" },
    { japanese: "バスケットボール", english: "basketball" },
    { japanese: "バット", english: "bat" },
    { japanese: "美しい", english: "beautiful" },
    { japanese: "ベッド", english: "bed" },
    { japanese: "一番良い", english: "best" },
    { japanese: "大きい", english: "big" },
    { japanese: "自転車", english: "bike" },
    { japanese: "鳥", english: "bird" },
    { japanese: "誕生日", english: "birthday" },
    { japanese: "黒い", english: "black" },
    { japanese: "青い", english: "blue" },
    { japanese: "ボート", english: "boat" },
    { japanese: "本", english: "book" },
    { japanese: "両方", english: "both" },
    { japanese: "箱", english: "box" },
    { japanese: "少年", english: "boy" },
    { japanese: "パン", english: "bread" },
    { japanese: "朝食", english: "breakfast" },
    { japanese: "兄弟", english: "brother" },
    { japanese: "バス", english: "bus" },
    { japanese: "忙しい", english: "busy" },
    { japanese: "しかし", english: "but" },
    { japanese: "買う", english: "buy" },
    { japanese: "～のそばに、～よって", english: "by" },
    { japanese: "ケーキ", english: "cake" },
    { japanese: "カメラ", english: "camera" },
    { japanese: "～できる、してもよい", english: "can" },
    { japanese: "カナダ", english: "Canada" },
    { japanese: "帽子", english: "cap" },
    { japanese: "自動車", english: "car" },
    { japanese: "注意深い", english: "careful" },
    { japanese: "猫", english: "cat" },
    { japanese: "捕まえる，(列車に)間に合う", english: "catch" },
    { japanese: "いす", english: "chair" },
    { japanese: "機会", english: "chance" },
    { japanese: "教会", english: "church" },
    { japanese: "市民", english: "citizen" },
    { japanese: "市，都会", english: "city" },
    { japanese: "学級，授業", english: "class" },
    { japanese: "きれいな", english: "clean" },
    { japanese: "店員", english: "clerk" },
    { japanese: "冷たい，寒い", english: "cold" },
    { japanese: "集める", english: "collect" },
    { japanese: "色", english: "color" },
    { japanese: "来る", english: "come" },
    { japanese: "コンピュータ", english: "computer" },
    { japanese: "料理人", english: "cook" },
    { japanese: "涼しい", english: "cool" },
    { japanese: "国，いなか，地方", english: "country" },
    { japanese: "雌牛", english: "cow" },
    { japanese: "カップ", english: "cup" },
    { japanese: "踊る", english: "dance" },
    { japanese: "危険", english: "danger" },
    { japanese: "暗い，黒い", english: "dark" },
    { japanese: "日付", english: "date" },
    { japanese: "娘", english: "daughter" },
    { japanese: "日", english: "day" },
    { japanese: "１２月", english: "December" },
    { japanese: "机", english: "desk" },
    { japanese: "日記", english: "diary" },
    { japanese: "doの過去形", english: "did" },
    { japanese: "夕食", english: "dinner" },
    { japanese: "する", english: "do" },
    { japanese: "医者", english: "doctor" },
    { japanese: "３人称単数", english: "does" },
    { japanese: "犬", english: "dog" },
    { japanese: "人形", english: "doll" },
    { japanese: "ドア", english: "door" },
    { japanese: "夢", english: "dream" },
    { japanese: "飲む", english: "drink" },
    { japanese: "早い", english: "early" },
    { japanese: "東", english: "east" },
    { japanese: "やさしい，気楽に", english: "easy" },
    { japanese: "食べる", english: "eat" },
    { japanese: "卵", english: "egg" },
    { japanese: "8", english: "eight" },
    { japanese: "18", english: "eighteen" },
    { japanese: "80", english: "eighty" },
    { japanese: "11", english: "eleven" },
    { japanese: "英語", english: "English" },
    { japanese: "楽しむ", english: "enjoy" },
    { japanese: "晩", english: "evening" },
    { japanese: "毎～", english: "every" },
    { japanese: "だれでもみな", english: "everybody" },
    { japanese: "みんな", english: "everyone" },
    { japanese: "すべてのもの", english: "everything" },
    { japanese: "秋", english: "fall" },
    { japanese: "家族", english: "family" },
    { japanese: "有名な", english: "famous" },
    { japanese: "遠くに，はるかに", english: "far" },
    { japanese: "速い", english: "fast" },
    { japanese: "父", english: "father" },
    { japanese: "一番好きな", english: "favorite" },
    { japanese: "２月", english: "February" },
    { japanese: "野原，競技場", english: "field" },
    { japanese: "15", english: "fifteen" },
    { japanese: "50", english: "fifty" },
    { japanese: "すばらしい，元気な，晴れた", english: "fine" },
    { japanese: "１日", english: "first" },
    { japanese: "魚", english: "fish" },
    { japanese: "5", english: "five" },
    { japanese: "床，階", english: "floor" },
    { japanese: "花", english: "flower" },
    { japanese: "40", english: "forty" },
    { japanese: "4", english: "four" },
    { japanese: "14", english: "fourteen" },
    { japanese: "ひまな、無料の", english: "free" },
    { japanese: "金曜日", english: "Friday" },
    { japanese: "友人", english: "friend" },
    { japanese: "親しみやすい", english: "friendly" },
    { japanese: "～から", english: "from" },
    { japanese: "果物", english: "fruit" },
    { japanese: "満タンの、いっぱいの", english: "full" },
    { japanese: "おもしろいこと", english: "fun" },
    { japanese: "おかしい、おもしろい", english: "funny" },
    { japanese: "庭", english: "garden" },
    { japanese: "門", english: "gate" },
    { japanese: "得る，着く，乗る", english: "get" },
    { japanese: "少女", english: "girl" },
    { japanese: "与える，(会などを)開く", english: "give" },
    { japanese: "うれしい", english: "glad" },
    { japanese: "コップ，ガラス", english: "glass" },
    { japanese: "行く", english: "go" },
    { japanese: "良い", english: "good" },
    { japanese: "緑の", english: "green" },
    { japanese: "ギター", english: "guitar" },
    { japanese: "髪の毛", english: "hair" },
    { japanese: "半分", english: "half" },
    { japanese: "手", english: "hand" },
    { japanese: "幸福な，楽しい", english: "happy" },
    { japanese: "持っている，食べる", english: "have" },
    { japanese: "彼は", english: "he" },
    { japanese: "助ける", english: "help" },
    { japanese: "彼女の", english: "her" },
    { japanese: "ここに", english: "here" },
    { japanese: "彼女のもの", english: "hers" },
    { japanese: "彼女自身", english: "herself" },
    { japanese: "高い", english: "high" },
    { japanese: "彼を(に)", english: "him" },
    { japanese: "彼自身", english: "himself" },
    { japanese: "彼の", english: "his" },
    { japanese: "家を(へ)", english: "home" },
    { japanese: "宿題", english: "homework" },
    { japanese: "正直な", english: "honest" },
    { japanese: "病院", english: "hospital" },
    { japanese: "暑い", english: "hot" },
    { japanese: "ホテル", english: "hotel" },
    { japanese: "時間", english: "hour" },
    { japanese: "家", english: "house" },
    { japanese: "どのくらい", english: "how" },
    { japanese: "空腹の", english: "hungry" },
    { japanese: "私は(が)", english: "I" },
    { japanese: "病気の", english: "ill" },
    { japanese: "～に、～で", english: "in" },
    { japanese: "興味深い", english: "interesting" },
    { japanese: "それは", english: "it" },
    { japanese: "それの", english: "its" },
    { japanese: "それ自身", english: "itself" },
    { japanese: "１月", english: "January" },
    { japanese: "日本", english: "Japan" },
    { japanese: "日本語", english: "Japanese" },
    { japanese: "７月", english: "July" },
    { japanese: "６月", english: "June" },
    { japanese: "年下の，下級の", english: "junior" },
    { japanese: "親切な", english: "kind" },
    { japanese: "台所", english: "kitchen" },
    { japanese: "知っている", english: "know" },
    { japanese: "大きい，広い", english: "large" },
    { japanese: "後で", english: "later" },
    { japanese: "学ぶ，覚える", english: "learn" },
    { japanese: "去る，残す，置いて行く", english: "leave" },
    { japanese: "左", english: "left" },
    { japanese: "レモン", english: "lemon" },
    { japanese: "手紙", english: "letter" },
    { japanese: "図書館", english: "library" },
    { japanese: "明るい", english: "light" },
    { japanese: "好む", english: "like" },
    { japanese: "線，列", english: "line" },
    { japanese: "小さい，幼い，ちょっとした", english: "little" },
    { japanese: "住む，生きる", english: "live" },
    { japanese: "長い", english: "long" },
    { japanese: "見る，～に見える", english: "look" },
    { japanese: "たくさん", english: "lot" },
    { japanese: "低い", english: "low" },
    { japanese: "昼食", english: "lunch" },
    { japanese: "郵便", english: "mail" },
    { japanese: "作る，～を～にする", english: "make" },
    { japanese: "男の人", english: "man" },
    { japanese: "多くの", english: "many" },
    { japanese: "地図", english: "map" },
    { japanese: "３月", english: "March" },
    { japanese: "数学", english: "math" },
    { japanese: "５月", english: "May" },
    { japanese: "私を", english: "me" },
    { japanese: "食事", english: "meal" },
    { japanese: "会う", english: "meet" },
    { japanese: "メートル", english: "meter" },
    { japanese: "牛乳", english: "milk" },
    { japanese: "私のもの", english: "mine" },
    { japanese: "分，ちょっとの間", english: "minute" },
    { japanese: "ミット", english: "mitt" },
    { japanese: "月曜日", english: "Monday" },
    { japanese: "月", english: "month" },
    { japanese: "朝", english: "morning" },
    { japanese: "ほとんど", english: "most" },
    { japanese: "母", english: "mother" },
    { japanese: "動く，感動させる", english: "move" },
    { japanese: "(男性)～さん", english: "Mr. ～" },
    { japanese: "(女性)～さん", english: "Ms. ～" },
    { japanese: "ずっと，たいへん", english: "much" },
    { japanese: "音楽", english: "music" },
    { japanese: "私の", english: "my" },
    { japanese: "私自身を", english: "myself" },
    { japanese: "名前", english: "name" },
    { japanese: "必要とする", english: "need" },
    { japanese: "新しい", english: "new" },
    { japanese: "次の，隣の", english: "next" },
    { japanese: "すばらしい", english: "nice" },
    { japanese: "夜", english: "night" },
    { japanese: "9", english: "nine" },
    { japanese: "19", english: "nineteen" },
    { japanese: "90", english: "ninety" },
    { japanese: "いいえ", english: "no" },
    { japanese: "だれも～ない", english: "nobody" },
    { japanese: "うるさい", english: "noisy" },
    { japanese: "何も(だれも)～ない", english: "none" },
    { japanese: "正午", english: "noon" },
    { japanese: "北", english: "north" },
    { japanese: "～でない", english: "not" },
    { japanese: "ノート", english: "notebook" },
    { japanese: "何も～ない", english: "nothing" },
    { japanese: "１１月", english: "November" },
    { japanese: "今", english: "now" },
    { japanese: "数", english: "number" },
    { japanese: "看護婦", english: "nurse" },
    { japanese: "～時", english: "o'clock" },
    { japanese: "１０月", english: "October" },
    { japanese: "～の", english: "of" },
    { japanese: "事務所", english: "office" },
    { japanese: "しばしば", english: "often" },
    { japanese: "年をとった，古い", english: "old" },
    { japanese: "～の上に、～に", english: "on" },
    { japanese: "1", english: "one" },
    { japanese: "開ける", english: "open" },
    { japanese: "～または", english: "or" },
    { japanese: "オレンジ", english: "orange" },
    { japanese: "私たちの", english: "our" },
    { japanese: "私たちのもの", english: "ours" },
    { japanese: "私たち自身を", english: "ourselves" },
    { japanese: "親", english: "parent" },
    { japanese: "公園", english: "park" },
    { japanese: "ペン", english: "pen" },
    { japanese: "鉛筆", english: "pencil" },
    { japanese: "人々", english: "people" },
    { japanese: "ピアノ", english: "piano" },
    { japanese: "絵，写真", english: "picture" },
    { japanese: "パイロット", english: "pilot" },
    { japanese: "場所", english: "place" },
    { japanese: "飛行機", english: "plane" },
    { japanese: "遊ぶ，(スポーツを)をする，演奏する", english: "play" },
    { japanese: "選手，演奏者", english: "player" },
    { japanese: "貧乏な，かわいそうな，不十分な", english: "poor" },
    { japanese: "人気のある", english: "popular" },
    { japanese: "ポット", english: "pot" },
    { japanese: "プレゼント", english: "present" },
    { japanese: "置く", english: "put" },
    { japanese: "質問", english: "question" },
    { japanese: "静かな", english: "quiet" },
    { japanese: "ラケット", english: "racket" },
    { japanese: "雨", english: "rain" },
    { japanese: "読む", english: "read" },
    { japanese: "赤い", english: "red" },
    { japanese: "金持ちの，豊かな", english: "rich" },
    { japanese: "乗る", english: "ride" },
    { japanese: "右，権利", english: "right" },
    { japanese: "部屋", english: "room" },
    { japanese: "バラ", english: "rose" },
    { japanese: "走る", english: "run" },
    { japanese: "悲しい", english: "sad" },
    { japanese: "土曜日", english: "Saturday" },
    { japanese: "学校", english: "school" },
    { japanese: "科学", english: "science" },
    { japanese: "季節", english: "season" },
    { japanese: "２日", english: "second" },
    { japanese: "売る", english: "sell" },
    { japanese: "送る", english: "send" },
    { japanese: "９月", english: "September" },
    { japanese: "7", english: "seven" },
    { japanese: "17", english: "seventeen" },
    { japanese: "70", english: "seventy" },
    { japanese: "彼女は", english: "she" },
    { japanese: "羊", english: "sheep" },
    { japanese: "短い，背が低い", english: "short" },
    { japanese: "恥ずかしがりの", english: "shy" },
    { japanese: "病気で(の)", english: "sick" },
    { japanese: "歌う", english: "sing" },
    { japanese: "歌手", english: "singer" },
    { japanese: "姉妹", english: "sister" },
    { japanese: "6", english: "six" },
    { japanese: "16", english: "sixteen" },
    { japanese: "60", english: "sixty" },
    { japanese: "遅い", english: "slow" },
    { japanese: "ゆっくりと", english: "slowly" },
    { japanese: "小さな", english: "small" },
    { japanese: "賢い", english: "smart" },
    { japanese: "雪", english: "snow" },
    { japanese: "そんなに", english: "so" },
    { japanese: "サッカー", english: "soccer" },
    { japanese: "いくつかの", english: "some" },
    { japanese: "だれか", english: "someone" },
    { japanese: "何か", english: "something" },
    { japanese: "時々", english: "sometimes" },
    { japanese: "息子", english: "son" },
    { japanese: "すぐに", english: "soon" },
    { japanese: "残念な", english: "sorry" },
    { japanese: "南", english: "south" },
    { japanese: "話す", english: "speak" },
    { japanese: "スポーツ", english: "sport" },
    { japanese: "春", english: "spring" },
    { japanese: "切手", english: "stamp" },
    { japanese: "立つ", english: "stand" },
    { japanese: "駅", english: "station" },
    { japanese: "滞在する", english: "stay" },
    { japanese: "止める，止まる", english: "stop" },
    { japanese: "店", english: "store" },
    { japanese: "強い，じょうぶな", english: "strong" },
    { japanese: "学生", english: "student" },
    { japanese: "勉強する", english: "study" },
    { japanese: "科目，題目", english: "subject" },
    { japanese: "夏", english: "summer" },
    { japanese: "日曜日", english: "Sunday" },
    { japanese: "夕食", english: "supper" },
    { japanese: "泳ぐ", english: "swim" },
    { japanese: "テーブル", english: "table" },
    { japanese: "背の高い", english: "tall" },
    { japanese: "テープ", english: "tape" },
    { japanese: "先生", english: "teacher" },
    { japanese: "10", english: "ten" },
    { japanese: "テニス", english: "tennis" },
    { japanese: "あの", english: "that" },
    { japanese: "その", english: "the" },
    { japanese: "彼(女)らの", english: "their" },
    { japanese: "彼(女)らのもの", english: "theirs" },
    { japanese: "彼(女)らを(に)", english: "them" },
    { japanese: "彼(女)ら自身", english: "themselves" },
    { japanese: "そこに", english: "there" },
    { japanese: "これらの", english: "these" },
    { japanese: "それらは，彼(女)らは", english: "they" },
    { japanese: "こと・物", english: "thing" },
    { japanese: "３日", english: "third" },
    { japanese: "13", english: "thirteen" },
    { japanese: "30", english: "thirty" },
    { japanese: "この", english: "this" },
    { japanese: "あれらの", english: "those" },
    { japanese: "3", english: "three" },
    { japanese: "木曜日", english: "Thursday" },
    { japanese: "時，～回", english: "time" },
    { japanese: "～へ", english: "to" },
    { japanese: "今日，現在", english: "today" },
    { japanese: "一緒に", english: "together" },
    { japanese: "明日", english: "tomorrow" },
    { japanese: "～もまた，～すぎる", english: "too" },
    { japanese: "町", english: "town" },
    { japanese: "電車、列車", english: "train" },
    { japanese: "木", english: "tree" },
    { japanese: "試す", english: "try" },
    { japanese: "火曜日", english: "Tuesday" },
    { japanese: "テレビ", english: "TV" },
    { japanese: "12", english: "twelve" },
    { japanese: "20", english: "twenty" },
    { japanese: "2", english: "two" },
    { japanese: "おじ", english: "uncle" },
    { japanese: "～の下に", english: "under" },
    { japanese: "上へ", english: "up" },
    { japanese: "私たちを(に)", english: "us" },
    { japanese: "使う", english: "use" },
    { japanese: "ふつう", english: "usually" },
    { japanese: "非常に", english: "very" },
    { japanese: "村", english: "village" },
    { japanese: "訪問する", english: "visit" },
    { japanese: "待つ", english: "wait" },
    { japanese: "散歩", english: "walk" },
    { japanese: "壁", english: "wall" },
    { japanese: "欲しい", english: "want" },
    { japanese: "温暖な", english: "warm" },
    { japanese: "洗う", english: "wash" },
    { japanese: "腕時計", english: "watch" },
    { japanese: "道，方法", english: "way" },
    { japanese: "私たちは", english: "we" },
    { japanese: "天気", english: "weather" },
    { japanese: "水曜日", english: "Wednesday" },
    { japanese: "週", english: "week" },
    { japanese: "よく，じょうずに", english: "well" },
    { japanese: "西", english: "west" },
    { japanese: "何", english: "what" },
    { japanese: "どこに", english: "where" },
    { japanese: "どちら", english: "which" },
    { japanese: "白い", english: "white" },
    { japanese: "だれ", english: "who" },
    { japanese: "だれの(もの)", english: "whose" },
    { japanese: "なぜ", english: "why" },
    { japanese: "窓", english: "window" },
    { japanese: "冬", english: "winter" },
    { japanese: "～といっしよに", english: "with" },
    { japanese: "女性", english: "woman" },
    { japanese: "仕事，作品", english: "work" },
    { japanese: "書く，手紙を書く", english: "write" },
    { japanese: "中庭", english: "yard" },
    { japanese: "年", english: "year" },
    { japanese: "はい", english: "yes" },
    { japanese: "昨日", english: "yesterday" },
    { japanese: "まだ(～でない)", english: "yet" },
    { japanese: "あなたに(を)，あなたがたを", english: "you" },
    { japanese: "若い", english: "young" },
    { japanese: "あなたの，あなたがたの", english: "your" },
    { japanese: "あなたのもの，あなたがたのもの", english: "yours" },
    { japanese: "あなた自身", english: "yourself" },
    { japanese: "ほんとうの", english: "true" }
];

// ===== Game State =====
let currentQuestionIndex = 0;
let score = 0;
let streak = 0;
let totalAnswered = 0;
let currentWord = null;
let shuffledVocabulary = [];
let incorrectCount = 0;

// ===== DOM Elements =====
const wordEl = document.getElementById('word');
const answerInput = document.getElementById('answer-input');
const submitBtn = document.getElementById('submit-btn');
const feedbackEl = document.getElementById('feedback');
const nextBtn = document.getElementById('next-btn');
const restartBtn = document.getElementById('restart-btn');
const currentQuestionEl = document.getElementById('current-question');
const totalQuestionsEl = document.getElementById('total-questions');
const scoreEl = document.getElementById('score');
const accuracyEl = document.getElementById('accuracy');
const streakEl = document.getElementById('streak');

// ===== Audio Context for Sound Effects =====
let audioContext = null;

// Initialize AudioContext on first user interaction (required for mobile)
function initAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        console.log('AudioContext initialized');
    }
}

// ===== Sound Effects =====
function playCorrectSound() {
    if (!audioContext) return;

    try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
    } catch (error) {
        console.error('Error playing correct sound:', error);
    }
}

function playIncorrectSound() {
    if (!audioContext) return;

    try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
        oscillator.type = 'sawtooth';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
    } catch (error) {
        console.error('Error playing incorrect sound:', error);
    }
}

// ===== Speech Synthesis for Pronunciation =====
// Using Speech Synthesis API with mobile-friendly implementation
function speakWord(word) {
    console.log('speakWord called with:', word);

    try {
        // Ensure speech synthesis is available
        if (!window.speechSynthesis) {
            console.error('Speech Synthesis not supported');
            return;
        }

        // Cancel any ongoing speech
        window.speechSynthesis.cancel();

        // Create utterance
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = 'en-US';
        utterance.rate = 0.8;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        // Event handlers
        utterance.onstart = () => {
            console.log('Speech started:', word);
        };

        utterance.onend = () => {
            console.log('Speech ended:', word);
        };

        utterance.onerror = (event) => {
            console.error('Speech error:', event.error);
            if (event.error === 'not-allowed') {
                console.error('Speech not allowed - user interaction may be required');
            }
        };

        // Get voices and select English voice
        const voices = window.speechSynthesis.getVoices();
        console.log('Available voices:', voices.length);

        if (voices.length > 0) {
            // Try to find a good English voice (avoid Google voices as they may cause 404)
            const englishVoice = voices.find(v =>
                v.lang.startsWith('en') && !v.name.includes('Google')
            ) || voices.find(v => v.lang.startsWith('en'));

            if (englishVoice) {
                utterance.voice = englishVoice;
                console.log('Using voice:', englishVoice.name, englishVoice.lang);
            }
        }

        // Small delay to ensure cancel completes
        setTimeout(() => {
            console.log('Calling speechSynthesis.speak()');
            window.speechSynthesis.speak(utterance);

            // Force resume if paused (iOS Safari fix)
            setTimeout(() => {
                if (window.speechSynthesis.paused) {
                    console.log('Speech was paused, resuming...');
                    window.speechSynthesis.resume();
                }
            }, 100);
        }, 100);

    } catch (error) {
        console.error('Failed to speak word:', error);
    }
}

// ===== Initialize Game =====
function initGame() {
    // Shuffle all vocabulary and select 10 random questions
    const allVocabulary = [...vocabulary].sort(() => Math.random() - 0.5);
    shuffledVocabulary = allVocabulary.slice(0, 10); // Take first 10 after shuffle

    // Reset state
    currentQuestionIndex = 0;
    score = 0;
    streak = 0;
    totalAnswered = 0;

    // Update UI
    totalQuestionsEl.textContent = shuffledVocabulary.length;
    updateStats();

    // Load first question
    loadQuestion();
}

// ===== Load Question =====
function loadQuestion() {
    if (currentQuestionIndex >= shuffledVocabulary.length) {
        showResults();
        return;
    }

    currentWord = shuffledVocabulary[currentQuestionIndex];
    incorrectCount = 0;

    wordEl.textContent = currentWord.japanese;
    answerInput.value = '';
    answerInput.disabled = false;
    submitBtn.disabled = false;
    feedbackEl.textContent = '';
    feedbackEl.className = 'feedback';
    nextBtn.classList.add('hidden');

    currentQuestionEl.textContent = currentQuestionIndex + 1;

    answerInput.focus();
}

// ===== Update Stats =====
function updateStats() {
    scoreEl.textContent = score;
    const accuracy = totalAnswered > 0 ? Math.round((score / totalAnswered) * 100) : 100;
    accuracyEl.textContent = `${accuracy}%`;
    streakEl.textContent = streak;
}

// ===== Check Answer =====
function checkAnswer() {
    // Initialize AudioContext on first interaction (required for mobile)
    initAudioContext();

    const userAnswer = answerInput.value.trim().toLowerCase();
    const correctAnswer = currentWord.english.toLowerCase();

    if (!userAnswer) {
        return;
    }

    if (userAnswer === correctAnswer) {
        handleCorrectAnswer();
    } else {
        handleIncorrectAnswer();
    }
}

// ===== Handle Correct Answer =====
function handleCorrectAnswer() {
    score++;
    streak++;
    totalAnswered++;
    incorrectCount = 0;

    playCorrectSound();
    speakWord(currentWord.english);

    feedbackEl.textContent = `✓ 正解！ "${currentWord.english}"`;
    feedbackEl.className = 'feedback correct';

    answerInput.disabled = true;
    submitBtn.disabled = true;

    console.log('Next button should be visible now, classList:', nextBtn.className);
    nextBtn.classList.remove('hidden');
    nextBtn.focus();

    updateStats();
}

// ===== Handle Incorrect Answer =====
function handleIncorrectAnswer() {
    incorrectCount++;

    playIncorrectSound();

    if (incorrectCount >= 3) {
        streak = 0;
        totalAnswered++;

        feedbackEl.textContent = `✗ 不正解。正解は "${currentWord.english}" です。`;
        feedbackEl.className = 'feedback incorrect';

        speakWord(currentWord.english);

        answerInput.disabled = true;
        submitBtn.disabled = true;

        console.log('Next button should be visible now, classList:', nextBtn.className);
        nextBtn.classList.remove('hidden');
        nextBtn.focus();

        updateStats();
    } else {
        feedbackEl.textContent = `✗ 不正解。もう一度試してください。(${incorrectCount}/3)`;
        feedbackEl.className = 'feedback incorrect';
        answerInput.value = '';
        answerInput.focus();
    }
}

// ===== Next Question =====
function nextQuestion() {
    currentQuestionIndex++;
    loadQuestion();
}

// ===== Show Results =====
function showResults() {
    wordEl.textContent = 'クイズ終了！';
    answerInput.style.display = 'none';
    submitBtn.style.display = 'none';
    nextBtn.style.display = 'none';
    restartBtn.style.display = 'block';

    const accuracy = totalAnswered > 0 ? Math.round((score / totalAnswered) * 100) : 100;
    feedbackEl.textContent = `お疲れ様でした！スコア: ${score}/${totalAnswered} (${accuracy}%)`;
    feedbackEl.className = 'feedback';
}

// ===== Event Listeners =====
submitBtn.addEventListener('click', checkAnswer);

answerInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        checkAnswer();
    }
});

nextBtn.addEventListener('click', nextQuestion);

restartBtn.addEventListener('click', () => {
    answerInput.style.display = 'block';
    submitBtn.style.display = 'block';
    nextBtn.style.display = 'block';
    restartBtn.style.display = 'none';

    // Restart game
    initGame();
});


// ===== Initialize on Load =====
window.addEventListener('load', () => {
    // Initialize game
    initGame();
});
